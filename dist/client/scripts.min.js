/*!
 * Piecemeal
 * 
 * 
 * @author Punnett Square
 * @version 0.0.0
 * Copyright . ISC licensed.
 */
angular.module("Piecemeal",["ui.router","ngMessages"]).constant("_",window._).run(function(a){a._=window._}),function(){"use strict";function a(a,b){var c={},d=function(a){return c[window.sessionStorage.user_id]?void 0:(c[window.sessionStorage.user_id]=!0,a({method:"POST",url:"/"+window.sessionStorage.code,data:{user_id:parseInt(window.sessionStorage.user_id)}}))};console.log("window.sessionStorage =",window.sessionStorage),b.otherwise(function(a){var b=a.get("$state");window.sessionStorage.username&&"undefined"!==window.sessionStorage.username?b.go("event.allDishes"):b.go("home")}),a.state("home",{url:"/home",views:{navbar:{templateUrl:"components/navbar/navbar.html",controller:"NavbarCtrl",controllerAs:"navbar"},"@":{templateUrl:"app/home/home.html",controller:"HomeCtrl",controllerAs:"home"}}}).state("oAuth",{url:"/oAuth",views:{navbar:{templateUrl:"components/navbar/navbar.html",controller:"NavbarCtrl",controllerAs:"navbar"},"@":{templateUrl:"app/oAuth/oAuth.html",controller:"OAuthCtrl",controllerAs:"oAuth"}}}).state("dashboard",{url:"/dashboard",views:{navbar:{templateUrl:"components/navbar/navbar.html",controller:"NavbarCtrl",controllerAs:"navbar"},"@":{templateUrl:"app/dashboard/dashboard.html",controller:"DashboardCtrl",controllerAs:"dashboard"}}}).state("404",{url:"/404",views:{navbar:{templateUrl:"components/navbar/navbar.html",controller:"NavbarCtrl",controllerAs:"navbar"},"@":{templateUrl:"404.html"}}}).state("event",{url:"/:id",views:{navbar:{templateUrl:"components/navbar/navbar.html",controller:"NavbarCtrl",controllerAs:"navbar"}}}).state("event.addDish",{url:"/addDish",views:{"@":{templateUrl:"app/addDish/addDish.html",controller:"AddDishCtrl",controllerAs:"addDish"}},resolve:{getEventInfo:["$http",d]}}).state("event.allDishes",{url:"/allDishes",views:{"@":{templateUrl:"app/allDishes/allDishes.html",controller:"AllDishesCtrl",controllerAs:"allDishes"}},resolve:{getEventInfo:["$http",d]}}).state("event.guestBill",{url:"/guestBill",views:{"@":{templateUrl:"app/guestBill/guestBill.html",controller:"GuestBillCtrl",controllerAs:"guestBill"}},resolve:{getEventInfo:["$http",d]}}).state("event.hostReceipt",{url:"/hostReceipt",views:{"@":{templateUrl:"app/hostReceipt/hostReceipt.html",controller:"HostReceipt",controllerAs:"hostReceipt"}},resolve:{}}).state("event.hostBill",{url:"/hostBill",views:{"@":{templateUrl:"app/hostBill/hostBill.html",controller:"HostBillCtrl",controllerAs:"hostBill"}},resolve:{getEventInfo:["$http",d]}}).state("event.loading",{url:"/loading",views:{"@":{templateUrl:"app/loading/loading.html",controller:"LoadingCtrl",controllerAs:"loading"}},resolve:{}})}angular.module("Piecemeal").config(a),a.$inject=["$stateProvider","$urlRouterProvider"]}(),function(){"use strict";function a(a,b){function c(){var a=b.location.origin+"/"+b.sessionStorage.code;b.socket=io(a)}function d(c,d){b.socket.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b.socket,c)})})}function e(c,d,e){b.socket.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b.socket,c)})})}var f={on:d,emit:e,init:c};return f}angular.module("Piecemeal").factory("socketFactory",a),a.$inject=["$rootScope","$window"]}(),function(){"use strict";function a(a,b,c,d){function e(a){return"code"===a?c.sessionStorage.code:"event_id"===a?parseInt(c.sessionStorage.event_id):"isHost"===a?"false"===c.sessionStorage.isHost?!1:!0:"user_id"===a?parseInt(c.sessionStorage.user_id):"username"===a?c.sessionStorage.username:void 0}function f(a){for(var b in c.sessionStorage)a[b]=e(b)}function g(a){return a.cost/a.users.length}function h(a){if(a=_.map(a,_.capitalize),1===a.length)return a[0];if(2===a.length)return a.join(" and ");var b=a.pop();return a.join(", ")+" and "+b}function i(){d.path("/"+t.getSessStorage("code")+"/addDish")}function j(){d.path("/"+t.getSessStorage("code")+"/allDishes")}function k(){d.path("/"+t.getSessStorage("code")+"/guestBill")}function l(){d.path("/"+t.getSessStorage("code")+"/hostBill")}function m(){d.path("/home")}function n(a){for(var b=0;b<t.data.users.length;b++)t.data.users[b].id===a.user_id&&t.data.users[b].dishes.push(a);t.data.dishes.push(a)}function o(a,b){var c;t.data.dishes.forEach(function(d){d.dish_id===a&&(d.users.push(b),c=d)}),t.data.users.forEach(function(a){a.id===b&&a.dishes.push(c)})}function p(a,b){t.data.dishes.forEach(function(c,d){c.dish_id===a&&(c.users.splice(c.users.indexOf(b),1),0===c.users.length&&t.data.dishes.splice(d,1))}),t.data.users.forEach(function(c){if(c.id===b){var d=c.dishes.reduce(function(b,c,d){return b||0===b?b:c.dish_id===a?d:void 0},!1);c.dishes.splice(d,1)}})}function q(){for(var a in c.sessionStorage)delete c.sessionStorage[a];m(),c.location.reload()}function r(a,b){return h(_(a.users).map(function(a){return b[_.findIndex(b,{id:a})].username}).value())}function s(){a.on("joined",function(a){console.log("Heard 'joined' in appFactory.data:",a),t.data=a,b.$broadcast("joined")}),a.on("newParticipant",function(a){console.log("Heard 'newParticipant' in appFactory:",a),t.data.users.push(a)}),a.on("dishAdded",function(a){console.log("Heard 'dishAdded' in appFactory.data:",a),n(a)}),a.on("dishShared",function(a){console.log("Heard 'dishShared' in appFactory.data:",a),o(a.dish_id,a.user_id)}),a.on("dishUnshared",function(a){console.log("Heard 'dishUnshared' in appFactory.data:",a),p(a.dish_id,a.user_id)}),a.on("billsSentToGuests",function(a){console.log("Heard 'billsSentToGuests' in appFactory.data:",a),t.data.billData=a,b.$broadcast("billsSentToGuests")})}var t={initListeners:s,addDish:n,shareDish:o,unshareDish:p,getSessStorage:e,arrayToSentence:h,getUsersByDish:r,getDishIndivCost:g,goToAllDishes:j,goToGuestBill:k,goToAddDish:i,goToHostBill:l,goToHome:m,copySessData:f,logout:q};return t}angular.module("Piecemeal").factory("appFactory",a),a.$inject=["socketFactory","$rootScope","$window","$location"]}(),function(){"use strict";function a(a,b,c,d){var e=this;c.copySessData(e),d.$on("joined",function(){e.data=c.data,console.log("Joined the Add Dish room."),e.calcUserCurrentTotal(e.data)}),e.data=c.data,e.calcUserCurrentTotal=function(a){return a?b.calculateRunningTotal(a):0},c.data?e.calcUserCurrentTotal(e.data):(a.init(),c.initListeners()),e.addDish=function(b,c){var d={cost:Number(c),name:b,user_id:e.user_id,event_id:e.event_id,users:[e.user_id]};a.emit("addDish",d),e.amount="",e.dishName="",e.addedDish=!0,e.previousDish=b},e.logout=c.logout}angular.module("Piecemeal").controller("AddDishCtrl",a),a.$inject=["socketFactory","addDishFactory","appFactory","$scope"]}(),function(){"use strict";function a(a){function b(b){return b?_.filter(b.dishes,function(b,c){return _.contains(b.users,a.getSessStorage("user_id"))}).reduce(function(a,b){return a+Number(b.cost)/b.users.length},0):0}var c={calculateRunningTotal:b};return c}angular.module("Piecemeal").factory("addDishFactory",a),a.$inject=["appFactory"]}(),function(){"use strict";function a(a,b,c){var d=this;b.copySessData(d),c.$on("joined",function(){d.data=b.data,console.log("Joined the All Dishes room.")}),d.data=b.data,b.data||(a.init(),b.initListeners()),d.getUsersByDish=b.getUsersByDish,d.isOnDish=function(a,b){return a.reduce(function(a,c){return c.toString()===b.toString()?!0:a},!1)},d.shareDish=function(c,e,f){d.isOnDish(f,e)||(a.emit("shareDish",{dish_id:c,user_id:e}),b.shareDish(c,e))},d.unshareDish=function(c,e,f){d.isOnDish(f,e)&&(a.emit("unshareDish",{dish_id:c,user_id:e}),b.unshareDish(c,e))},d.logout=b.logout}angular.module("Piecemeal").controller("AllDishesCtrl",a),a.$inject=["socketFactory","appFactory","$scope"]}(),function(){"use strict";function a(a,b){var c={};return c}angular.module("Piecemeal").factory("allDishesFactory",a),a.$inject=["$http","$window"]}(),function(){"use strict";function a(a,b,c,d){var e=this;e.getUsers=function(a){return d.arrayToSentence(a.map(function(a){return a.username}))},e.getDishNames=function(a){return d.arrayToSentence(a.dishes.map(function(a){return a.name}))},a.createEvent().then(function(a){a=a.data,_.assign(b.sessionStorage,{username:a.username,code:a.code,isHost:!0,user_id:a.user_id,event_id:a.event_id}),c.path("/"+a.code+"/allDishes")})["catch"](function(a){console.log("Error in creating event.")})}angular.module("Piecemeal").controller("DashboardCtrl",a),a.$inject=["dashboardFactory","$window","$location","appFactory"]}(),function(){"use strict";function a(a){function b(){return a({method:"GET",url:"/auth/createEvent"})}function c(){return a({method:"GET",url:"/auth/getBills"})}var d={getBills:c,createEvent:b};return d}angular.module("Piecemeal").factory("dashboardFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c,d){var e=this;b.copySessData(e),a.$on("joined",function(){e.data=b.data,e.data.billData=b.data.billData,e.getDishIndivCost=b.getDishIndivCost,e.venmoUsername=b.data.venmoUsername}),e.data=b.data,b.data?(e.getDishIndivCost=b.getDishIndivCost,e.venmoUsername=b.data.venmoUsername):(d.init(),b.initListeners()),a.$on("billsSentToGuests",function(){e.data.billData=b.data.billData}),e.getGuestDishes=function(a,b){return e.data?_.filter(b,function(b,c){return _.contains(b.users,a)}):[]},e.getGuestTotal=function(a){return c.calculateRunningTotal(a)},e.getGrandTotal=function(a,b){return e.data?_.sum(_.pluck(a,"cost"))+b.tipPercent+b.taxPercent:0},e.getOtherUsersByUsername=function(a,c,d){return b.arrayToSentence(_(a.users).filter(function(a){return a!==d}).map(function(a){return c[_.findIndex(c,{id:a})].username}).value())},e.getGuestTax=function(){return e.data?e.data.billData.taxPercent*e.getGuestTotal(e.data)*.01:0},e.getGuestTip=function(){return e.data?e.data.billData.tipPercent*e.getGuestTotal(e.data)*.01:0},e.getGuestGrandTotal=function(){return e.data?e.getGuestTotal(e.data)+e.data.billData.taxPercent*e.getGuestTotal(e.data)*.01+e.data.billData.tipPercent*e.getGuestTotal(e.data)*.01:0},e.logout=b.logout}angular.module("Piecemeal").controller("GuestBillCtrl",a),a.$inject=["$scope","appFactory","addDishFactory","socketFactory"]}(),function(){"use strict";function a(){function a(){}var b={showGuestBill:a};return b}angular.module("Piecemeal").factory("guestBillFactory",a),a.$inject=[]}(),function(){"use strict";function a(a){var b=this;b.setSessionUser=function(b){_.assign(a.sessionStorage,{code:b.toLowerCase(),isHost:!1})}}angular.module("Piecemeal").controller("HomeCtrl",a),a.$inject=["$window"]}(),function(){"use strict";function a(a){var b={};return b}angular.module("Piecemeal").factory("homeFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c){var d=this;a.copySessData(d),c.$on("joined",function(){d.data=a.data,d.getDishIndivCost=a.getDishIndivCost}),d.data=a.data,a.data?d.billsSent=!0:(b.init(),a.initListeners()),d.getDishIndivCost=a.getDishIndivCost,d.getUsersByDish=a.getUsersByDish,d.tipType="percent",d.taxType="percent",d.repopulateTip=function(a){return a?a.tipPercent:0},d.repopulateTax=function(a){return a?a.taxPercent:0},d.getTip=function(){return d.data?"dollar"===d.tipType?d.tip:"percent"===d.tipType?.01*d.tip*d.getSubTotal(d.data.dishes):void 0:0},d.getTipPercent=function(){if(!d.data)return 0;if("dollar"===d.tipType){var a=d.tip/d.getSubTotal(d.data.dishes)*100;return Math.round(100*a)/100}return"percent"===d.tipType?d.tip:void 0},d.getTax=function(){return d.data?"dollar"===d.taxType?d.tax:"percent"===d.taxType?.01*d.tax*d.getSubTotal(d.data.dishes):void 0:0},d.getTaxPercent=function(){if(!d.data)return 0;if("dollar"===d.taxType){var a=d.tax/d.getSubTotal(d.data.dishes)*100;return Math.round(100*a)/100}return"percent"===d.taxType?d.tax:void 0},d.getSubTotal=function(a){return _.sum(_.pluck(a,"cost"))},d.getGrandTotal=function(){return d.getSubTotal(d.data.dishes)+d.getTip()+d.getTax()},d.sendBillsToGuests=function(){b.emit("sendBillToGuests",{event_id:d.event_id,code:d.code,hostUsername:d.username,host_id:d.user_id,subTotal:d.getSubTotal(d.data.dishes),taxPercent:d.getTaxPercent(),tipPercent:d.getTipPercent(),grandTotal:d.getGrandTotal()}),d.billsSent=!0},d.logout=a.logout}angular.module("Piecemeal").controller("HostBillCtrl",a),a.$inject=["appFactory","socketFactory","$scope"]}(),function(){"use strict";function a(){function a(){}var b={showHostBill:a};return b}angular.module("Piecemeal").factory("hostBillFactory",a),a.$inject=[]}(),function(){"use strict";function a(a){var b=this;b.test="test"}angular.module("Piecemeal").controller("HostReceiptCtrl",a),a.$inject=["$scope"]}(),function(){"use strict";function a(){function a(){}var b={showHostReceipt:a};return b}angular.module("Piecemeal").factory("hostReceiptFactory",a),a.$inject=[]}(),function(){"use strict";function a(a,b,c,d,e){var f=this;if(!b.sessionStorage.getItem("code")){var g=a.path().split("/");b.sessionStorage.setItem("code",g[g.length-2])}f.setSessionUser=function(g){c.sendSessionUser(_.assign(b.sessionStorage,{isHost:!1,username:g})).then(function(c){_.assign(b.sessionStorage,{user_id:c.user_id,event_id:c.event_id}),f.isSent=!0,a.path("/"+b.sessionStorage.code+"/allDishes")})["catch"](function(a){console.log("Error: Could not send session user info."),console.error(a),f.isError=!0,e(function(){d.logout()},2e3)})}}angular.module("Piecemeal").controller("LoadingCtrl",a),a.$inject=["$location","$window","loadingFactory","appFactory","$timeout"]}(),function(){"use strict";function a(){function a(a,b,c){var d={lines:13,length:28,width:10,radius:42,scale:.25,corners:1,color:"#000",opacity:.2,rotate:0,direction:1,speed:1.8,trail:61,fps:20,zIndex:2e9,className:"spinner",top:"0%",left:"0%",shadow:!1,hwaccel:!1,position:"relative"},e=new Spinner(d).spin();b.replaceWith(e.el),b.on("$destroy",function(){e.stop()})}var b={link:a};return b}angular.module("Piecemeal").directive("loading",a)}(),function(){"use strict";function a(a){function b(b){return a({method:"POST",url:"/newUser",data:b}).then(function(a){return a.data})["catch"](function(a){console.log("Could not send username to server.")})}var c={sendSessionUser:b};return c}angular.module("Piecemeal").factory("loadingFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a,b,c){var d=this;d.venmoAuth=function(){return a.venmoLogin()},d.setSessionUser=function(d,e,f){a.createEvent({username:d}).then(function(a){_.assign(b.sessionStorage,{username:d,code:a.code,isHost:!0,user_id:a.user_id,event_id:a.event_id}),c.path("/"+a.code+"/allDishes")})["catch"](function(a){console.log("Error in creating event.")})}}angular.module("Piecemeal").controller("OAuthCtrl",a),a.$inject=["oAuthFactory","$window","$location"]}(),function(){"use strict";function a(a){function b(b){return a({method:"POST",url:"/createEvent",data:b}).then(function(a){return a.data})}var c={createEvent:b};return c}angular.module("Piecemeal").factory("oAuthFactory",a),a.$inject=["$http"]}(),function(){"use strict";function a(a){var b=this;b.logout=a.logout,b.goToAllDishes=a.goToAllDishes,b.goToGuestBill=a.goToGuestBill,b.goToAddDish=a.goToAddDish,b.goToHostBill=a.goToHostBill}angular.module("Piecemeal").controller("NavbarCtrl",a),a.$inject=["appFactory"]}();